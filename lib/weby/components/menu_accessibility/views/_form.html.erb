<div class="tabbable">
  <ul class="nav nav-tabs" id="style-tab">
    <li class="active" >
      <a href="#tab-main" data-toggle="tab"><%= t(".font_size") %></a>
    </li>
    <li>
      <a href="#tab-advanced" data-toggle="tab"><%= t(".contrast") %></a>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane active" id="tab-main" style="padding-left: 5px;">
      <%= f.input :font_size , wrapper_html: { class: "side" }, as: :boolean, input_html: { class: "check-button" } %>
    </div>
    <div class="tab-pane" id="tab-advanced">
      <%= f.input :contrast , wrapper_html: { class: "side" }, as: :boolean, input_html: { class: "check-button" } %>
      <%= f.input :own_contrast , wrapper_html: { class: "side" }, as: :boolean, input_html: { class: "check-button own_contrast" } %>
      <div id="form-contrast">
      <div class="form-group">
      <div class="col-md-9 col-md-offset-3">
        <div class="btn-toolbar">
          <div class="btn-group">
            <%= link_to t(".format"),"", class: "btn btn-default btn-sm" %>
            <%= link_to t(".comment"),")", class: "btn btn-default btn-sm" %>
            <%= link_to t(".uncomment"),"", class: "btn btn-default btn-sm" %>
            <%= link_to t(".insert_image"), "", class: "btn btn-default btn-sm" %>
          </div>
          <%= f.button :button, t(".apply"), type: :button, disabled: :disabled, class: "btn-apply btn btn-primary btn-sm" %>
        </div>
      </div>
    </div>
    <%= f.input :css_own_contrast , wrapper_html: { class: "side" }, as: :text %>
      </div>
  </div>
</div>
  <% content_for :stylesheets, stylesheet_link_tag("codeMirror/codemirror") %>
    <% content_for :javascripts, javascript_include_tag("init/codemirror") %>
    <% content_for :javascripts do %>
      <script type="text/javascript">
          var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode: 'css',
            lineNumbers: true,
            tabSize: 2,
            onCursorActivity: function() {
              editor.setLineClass(hlLine, null, null);
              hlLine = editor.setLineClass(editor.getCursor().line, null, "activeline");
            },
            onChange: function() {
              $('.btn-apply').prop('disabled',false);
            }
          });
          var hlLine = editor.setLineClass(0, "activeline");
          //CodeMirror.commands["selectAll"](editor);

          $('.btn-apply').click(function(){
            /////Retorna uma array dos erros, se tiver vazio = OK
            $.ajax({
              url: $(this).closest('form').prop('action'),
              type: "PUT",
              data: {'style[css]': editor.getValue()},
              dataType: "json",
              success: function(data, st, jqxhr){
                if(data.length > 0){
                  var str = ""
                  for (var e in data){
                    str += data[e]+"<br/>";
                  }
                  flashMsgApply('<%=image_tag("false.png")%>',"<%=t("simple_form.error_notification.default_message")%> <br/>"+str);
                  $('.btn-apply').prop('disabled',false);
                }else{
                  flashMsgApply('<%=image_tag("true.png")%>',"<%=t("successfully_updated")%>");
                  refreshIframe();
                }
              },
              error: function(jqxhr, st, error){
                flashMsgApply('<%=image_tag("false.png")%>',"<%=t("simple_form.error_notification.default_message")%> <br/>"+st);
                $('.btn-apply').prop('disabled',false);
              },
              beforeSend: function(){
                $('.btn-apply').prop('disabled',true);
              }
            })
          });

          function flashMsgApply(title, content){
            $('.btn-apply').popover({title:title,content:"<span style=\"font-size: 12pt;\">"+content+"</span>",animation:true, placement: "right", html: true, trigger: "manual"}).popover('show');
            setTimeout(function(){
              $('.btn-apply').popover('hide');
            },2000);
          }

          function getSelectedRange() {
            return { from: editor.getCursor(true), to: editor.getCursor(false) };
          }

          function autoFormatSelection() {
            var range = getSelectedRange();
            editor.autoFormatRange(range.from, range.to);
          }

          function commentSelection(isComment) {
            var range = getSelectedRange();
            editor.commentRange(isComment, range.from, range.to);
          }

          function insertImage(value){
            WEBY.getRepositoryDialog().open({
              file_types: ["image"],
              selected: value,
              multiple: false,
              onsubmit: insert_into_editor
            });
          }

          var insert_into_editor = function(value){
            var path = value[0].original_path.replace(/\?\d+$/, '')
            editor.replaceRange(path, editor.getCursor())
          }

            var own_contrast = function(value){
              $( ".own_contrast" ).prop("checked");
            }
            if(own_contrast == 'true'){
              $( "#form-contrast" ).show();
            }else{
              $( "#form-contrast" ).hide();
            }
      </script>
    <% end %>