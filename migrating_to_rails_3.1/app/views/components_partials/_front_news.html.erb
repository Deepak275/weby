<% quant = settings[:quant] || 5 %>
<% @front_news = @site.pages.order('position desc')
                  .news(true).page(params[:front_pages]).per(quant) %>

<section id="pages">
  <% @front_news.try(:each) do |page| %>
    <li id="sort_page_<%= "#{page.id}" %>" style="list-style-type:none;">
    <article>
      <% unless page.repository.nil? %>
        <%= weby_file_view(page.repository, :little, "128", nil, {as: "link", url: link_on_title(@site, page), target: '_self'}) %>
      <% end %>
      <header>
        <h2> <%= link_to page.by_locale(session[:locale]).title, link_on_title(@site, page) %> </h2>
        <% if @site.view_desc_pages %>
          <p>
          <i>
            <%= page.user.name_or_login %>
            <%= localize page.created_at, :format => :short  %>
          </i>
          </p>
        <% end %>
      </header>
      <summary>
        <%= raw page.by_locale(session[:locale]).summary %>
      </summary>
      <p> <%= link_to t("read_more"), site_page_path(@site, page) %> </p>
      <div class="clear"></div>
      <%= make_menu(page, :controller => PagesController) %>
      <% if check_permission(PagesController, ["sort"]) %>
        <%= link_to t("move"), "#", :class => 'handle icon icon-drag' if @front_news.length > 1 %>
      <% end %>
    </article>
  <% end %>
  </li>
  <%= paginate @front_news, :param_name => 'front_pages' %>
</section>

<%= javascript_tag do %>
  window.onload = function(){
    $().ready(function() {
      $('section#pages').sortable({
        axis: 'y',
        dropOnEmpty:false,
        handle: '.handle',
        items: 'li',
        opacity: 0.7,
        scroll: true,
        forcePlaceholderSize: true,
        placeholder: 'drop-here',
        update: function(ev, ui){
          id_moved = ui.item.attr('id').replace('sort_page_','');
          id_after = ui.item.next().attr('id') ? ui.item.next().attr('id').replace('sort_page_','') : 0;
          id_before = ui.item.prev().attr('id') ? ui.item.prev().attr('id').replace('sort_page_','') : 0;
          //alert(id_moved+' between '+id_before+' and '+id_after);
          $.ajax({
            type: 'post',
            data: {'id_moved':id_moved,'id_after':id_after,'id_before':id_before},
            dataType: 'script',
            complete: function(request){ ui.item.effect('highlight'); },
            error: function(){$('section#pages').sortable('cancel');},
            url: '<%= sort_site_pages_path(@site) %>'
          });
        }
      });
    });
  }
<% end %>
<%= content_for :stylesheets, stylesheet_link_tag("legacy/jquery/jquery.sortable") %>
