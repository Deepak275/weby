<fieldset>
  <legend><%= t"covers"  %></legend>

  <div class="contextual">
  <% if check_permission(PagesController, 'new') %>
    <%= link_to (t"new_param.fem", :param => (t"page.one")), new_site_page_path, :class => 'icon icon-add' %>&nbsp;|
  <% end %>
    <%= link_to (t"list_param", :param=>t("page.other") ), site_pages_path(@site), :class => 'icon icon-list' %>
  </div>

  <div id="page_list">
    <div class="page_info_paginator"><%= t"views.pagination.total" %>&nbsp;<%= @pages.length %></div>
    <table id='list' class="list">
      <thead>
        <th><%= t('id') %></th>
        <th><%= t("date_param", :param => t("register")) %></th>
        <th><%= t("title") %></th>
        <th><%= t("author") %></th>
        <th><%= t("category") %></th>
        <th><%= t("type") %></th>
        <% if check_permission(PagesController, [:toggle_field]) %>
          <th><%= link_to (t"publish"), list_front_site_pages_path(@site, published: params[:published]=='true' ? 'false':'true' ) %></th>
        <% end %>
        <th></th>
      </thead>
      <tbody>
        <% @pages.each do |page| %>
          <tr id="sort_page_<%= page.id %>">
            <td><%= page.id %></td>
            <td><%=l page.created_at, :format => :short %></td>
            <td><%= link_to page.by_locale(session[:locale]).title, site_page_path(@site,page) %></td>
            <% if page.user %>
              <td><%= page.user.first_name ? ("#{page.user.first_name} #{page.user.last_name}") : page.user.login %></td>
            <% else %>
              <td></td>
            <% end %>
            <td><%= page.category_list.join ', ' %></td>
            <td><%= t"#{page.type.downcase}.one" %></td>
            <% if check_permission(PagesController, [:toggle_field]) %>
              <td><%= publication_status(page) %></td>
            <% end %>
            <td>
              <%= make_menu(page, :except => "show") %>
              <% if check_permission(PagesController, 'sort') %>
                <span class='handle icon icon-drag'><%= t("move") %></span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <%= javascript_tag do %>
    window.onload=function(){
      $().ready(function() {
        $('#list').sortable({
          axis: 'y',
          dropOnEmpty:false,
          handle: '.handle',
          items: 'tbody > tr',
          opacity: 0.7,
          scroll: true,
          forcePlaceholderSize: true,
          placeholder: 'drop-here',
          update: function(ev, ui){
            id_moved = ui.item.attr('id').replace('sort_page_','');
            id_after = ui.item.next().attr('id') ? ui.item.next().attr('id').replace('sort_page_','') : 0;
            id_before = ui.item.prev().attr('id') ? ui.item.prev().attr('id').replace('sort_page_','') : 0;
            //alert(id_moved+' between '+id_before+' and '+id_after);
            $.ajax({
              type: 'post',
              data: {'id_moved':id_moved,'id_after':id_after,'id_before':id_before},
              dataType: 'script',
              complete: function(request){ ui.item.effect('highlight'); },
              error: function(){$('#list').sortable('cancel');},
              url: '<%= sort_site_pages_path %>'
            })
          }
        })
      })
    }
  <% end %>
</fieldset>
<%= content_for :stylesheets, stylesheet_link_tag("legacy/jquery/jquery.sortable") %>
