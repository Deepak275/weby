<fieldset>
  <legend><%= t"menu.other"  %></legend>

  <div class="contextual">
    <%= link_to (t"new_param.masc", :param => (t"menu_item.one")),  new_site_menu_path(:category => params[:category]), :class => 'icon icon-add'%>
  </div>

  <div id='tabs'>
    <ul>
      <% links = @site.menu_categories %>
      <% for link in links do %>
        <% selected = params[:category] == link ? "selected" : "" %>
        <li><%= link_to(link.try(:titleize), params[:category] == link ? '#' : site_menus_path(@site, :category => link), :rel => link, :class => "#{selected}") %></li>
      <% end %>
    </ul>
  </div>
  <div id='main-tabs'>
    <% unless @menus[params[:category]].blank? %>
      <%= raw print_menu(@menus[params[:category]], 1) %>
    <% end %>
  </div>
  <%= javascript_tag do %>
  window.onload=function(){
    $().ready(function() {

      ////FIX-ME
      $('#content').css({'overflow':'hidden'});

      var dropped = false;
      $('#main-tabs > menu').nestedSortable({
        listType: 'menu',
        handle: '.handle',
        items: 'li',
        opacity: 0.7,
        forcePlaceholderSize: true,
        placeholder: 'drop-here',
        tolerance: 'pointer',
        toleranceElement: '> div',
        update: function(event, ui){

          if(dropped){
            $(this).nestedSortable('cancel');
            dropped = false;
            return;
          }

          id = ui.item.attr('id').replace('menu_','');
          parent_id = ui.item.parents('li').attr('id') ? ui.item.parents('li').attr('id').replace('menu_','') : 0;
          position = ui.item.index()+1;//A position no banco começa com 1

          $.ajax({
            type: 'post',
            data: 'id='+id+'&parent_id='+parent_id+'&position='+position,
            dataType: 'script',
            complete: function(request,text){
              if(text=='success') $(ui.item).effect('highlight');
              else $('#main-tabs > menu').nestedSortable('cancel');
            },
            url: '<%= change_order_site_menus_path %>'
          });
        }
      });

      $( "#tabs li" ).droppable({
        hoverClass: "drop-here",
        tolerance: "pointer",
        drop: function( event, ui ) {
          drop_li = $(this)
          id = ui.draggable.attr('id').replace('menu_','');
          category = drop_li.find('a').attr('rel');

          dropped = true;

          ////Testa para não alterar pra a própria categoria
          if( !drop_li.find('a').hasClass('selected') ){

            $.ajax({
              type: 'post',
              data: 'id='+id+'&category='+category,
              dataType: 'script',
              complete: function(request,text){
                if(text=='success'){
                  ui.draggable.remove();
                  location = drop_li.find('a').attr('href');
                }
              },
              url: '<%= change_category_site_menus_path %>'
            });

          }
        }
      });

      $("a.selected").click(function(){
        return false;
      });

      var cur_anchor;
      $("a.selected").dblclick(function(){
        cont = $(this).parent();
        cur_anchor = $(this).detach();
        cat_edit = $(document.createElement('input'));
        cat_edit.attr('type','text');
        cat_edit.val(this.rel);
        cat_edit.blur(function(){
          cat_edit.val(trim(cat_edit.val()));
          if(cat_edit.val() != cur_anchor.attr('rel')){
            $.ajax({
              type: 'post',
              data: 'category='+cat_edit.val()+'&old_category='+cur_anchor.attr('rel'),
              dataType: 'script',
              complete: function(request,text){
                if(text=='success'){
                  cur_anchor.attr('rel',cat_edit.val());
                  cur_anchor.text(titleize(cat_edit.val()));
                }
                cat_edit.remove();
                cont.append(cur_anchor);
                location = '<%=site_menus_path(@site, :category => 'NEWCAT')%>'.replace('NEWCAT',cat_edit.val());
              },
              url: '<%= change_category_site_menus_path %>'
            });
            cat_edit.attr('disabled', true);
          }else{
            cat_edit.remove();
            cont.append(cur_anchor);
          }
        });
        cat_edit.keypress(function(event) {
          if ( event.which == 13 ) {
             event.preventDefault();
             $(this).blur();
           }
        });
        cont.append(cat_edit);
        cat_edit.focus();
      });

    })
  }

  function titleize(string){
      return string[0].toUpperCase() + string.slice(1);
  }
  function trim(str){
      return str.replace(/^\s+|\s+$/g,"");
  }
  <% end %>
</fieldset>
<%= content_for :javascripts, javascript_include_tag("jquery.ui.nestedSortable") %>
<%= content_for :stylesheets, stylesheet_link_tag("jquery.sortable") %>