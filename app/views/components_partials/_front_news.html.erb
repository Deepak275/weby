<% quant = settings[:quant] || 5 %>
<% @front_news = @site.pages.news(true).page(params[:front_pages]).per(quant) %>

<section id="pages">
  <% @front_news.try(:each) do |page| %>
    <li id="sort_page_<%= "#{page.id}" %>" style="list-style-type:none;">
    <article>
      <% unless page.repository.nil? %>
        <%= weby_file_view(page.repository, :little, "128", nil, {as: "link", url: link_on_title(@site, page), target: '_self'}) %>
      <% end %>
      <header>
        <h2> <%= link_to page.by_locale(session[:locale]).title, link_on_title(@site, page) %> </h2>
        <% if @site.view_desc_pages %>
          <p>
          <i>
            <%= page.user.name_or_login %>
            <%= localize page.created_at, :format => :short  %>
          </i>
          </p>
        <% end %>
      </header>
      <summary>
        <%= raw page.by_locale(session[:locale]).summary %>
      </summary>
      <p> <%= link_to t("read_more"), site_page_path(@site, page) %> </p>
      <div class="clear"></div>
      <%= make_menu(page, :controller => PagesController) %>
      <% if check_permission(PagesController, ["sort"]) %>
        <%= link_to t("move"), "#", :class => 'handle icon icon-drag' if @front_news.length > 1 %>
      <% end %>
    </article>
  <% end %>
  </li>
  <%= paginate @front_news, :param_name => 'front_pages', :theme => 'blog' %>
</section>

<%= javascript_tag do %>
  window.onload = function(){
    $().ready(function() {
      $('#list').sortable({
        axis: 'y', 
        dropOnEmpty:false, 
        handle: '.handle', 
        cursor: 'crosshair',
        items: 'li',
        opacity: 0.4,
        scroll: true,
        update: function(){ 
          $.ajax({ 
            type: 'post',
            data: $('#list').sortable('serialize'),
            dataType: 'script',
            complete: function(request){
              $('#list').effect('highlight'); 
            },
            url: '<%= params[:site_id] %>/pages/sort?from=view<%#= sort_sites_path(:from => 'view') %>'
          });
        }
      });
    });
  }
<% end %>
