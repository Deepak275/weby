<fieldset>
  <legend><%= t("component.other") %></legend>

  <div class="contextual">
    <% if check_permission(ComponentsController, 'new') %>
      <%= link_to t("new_param.masc", :param => t("component.one")),
        new_site_component_path, :class => "icon icon-add" %>
    <% end %>
  </div>

  <table id="list" class="list">
    <thead>
      <th>id</th>
      <th><%= t("component.one") %></th>
      <th><%= t("category") %></th>
      <th><%= t"active" %></th>
      <th></th>
    </thead>
    <tbody>
      <% @components.group_by(&:place_holder).sort.each do |place_holder, components| %>
        <tr>
          <td colspan="99" class="dark"><%= t("components.pos.#{place_holder}") %></td>
        </tr>
        <% components.each do |component| %>
          <% component = Weby::Components.factory(component) %>
          <tr id="sort_sites_component_<%= component.id %>" class="place-<%=  "#{place_holder}" -%>">
            <td><%= component.id %></td>
            <td><%= t("components.#{component.component_name}.name") %></td>
            <td><%= component.category rescue '--' %></td>
            <td align="center"><%= raw toggle_field(component, "publish") %></td>
            <td>
              <%= raw make_menu(component, :except => "show") %>
              <% if check_permission(ComponentsController, 'sort') %>
                <span class='handle icon icon-drag'><%= t("move") %></span>
              <% end %>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
  <%= javascript_tag do %>
    window.onload=function(){
      $().ready(function() {
        $('#list').sortable({
          axis: 'y', 
          dropOnEmpty:false, 
          handle: '.handle', 
          cursor: 'crosshair',
          items: 'tr',
          opacity: 0.4,
          scroll: true,
          update: function(){
            $.ajax({
              type: 'post', 
              data: $('#list').sortable('serialize'),
              dataType: 'script', 
              complete: function(request){ $('#list tr').effect('highlight'); },
              url: '<%= sort_site_components_path %>'
            })
          }
        })
      })
    }
  <% end %>
</fieldset>
<%= content_for :javascripts, javascript_include_tag("jquery.ui.nestedSortable") %>
<%= content_for :stylesheets, stylesheet_link_tag("jquery.sortable") %>
